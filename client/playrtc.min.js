/*! playrtc 2013-10-12 */
!function(a){"object"==typeof exports?module.exports=a():window.Playrtc=a()}(function(){"use strict";function a(a,b){return JSON.stringify({adminKind:a,data:b})}function b(a,b){return JSON.stringify({kind:a,data:b})}function c(a,b){return JSON.stringify({kind:a,data:b})}function d(a,b,c){return JSON.stringify({adminKind:"fwd",data:{to:a,msg:{adminKind:b,data:c}}})}function e(d,e){var f=this;f.server={},f.p2p={},f.id=void 0,f.webrtcConfig=e,f.ready=!1,f._members={},f._initialMembers=[],f._ws=new WebSocket(d),f._eventCbs={},f._readyEvtName="ready",f._connectEvtName="newMember",f._disconnectEvtName="memberLeft",f.server._msgCbs={},f.p2p._msgCbs={},f._ws.onmessage=function(b){var c=JSON.parse(b.data);if(c.hasOwnProperty("kind"))f.server._msgCbs.hasOwnProperty(c.kind)?f.server._msgCbs[c.kind].call(null,c.data):console.error("Received unknow kind: "+c.kind);else{var d=c.adminKind,e=c.data;if("initInfo"===d)f.id=e.id,f._initialMembers=e.members,0===e.members.length?f._triggerReady():e.members.forEach(function(a){f._members.hasOwnProperty(a)||f._initiateWebRtcHandshake(a)}),setInterval(function(){f._ws.send(a("hb",null))},e.hbInterval);else if("sdpOffer"===d)f._answerWebRtcHandshake(e.from,e.sdp);else if("sdpAnswer"===d)f._members[e.from].peerconn.setRemoteDescription(new RTCSessionDescription(e.sdp));else if("iceCandidate"===d)f._members.hasOwnProperty(e.from)?f._members[e.from].peerconn.addIceCandidate(new RTCIceCandidate(e.candidate)):console.error("ICE candidate sent before sdp-offer!");else if("disconnect"===d&&f._members.hasOwnProperty(e.id)){try{f._members[e.id].datachannel.close(),f._members[e.id].peerconn.close()}catch(g){}delete f._members[e.id],f._eventCbs.hasOwnProperty(f._disconnectEvtName)&&f._eventCbs[f._disconnectEvtName].call(null,e.id),f._isReady()&&f._triggerReady()}}},f.server.onMsg=function(a,b){f.server._msgCbs[a]=b},f.server.send=function(a,c){f._ws.send(b(a,c))},f.p2p.onMsg=function(a,b){f.p2p._msgCbs[a]=b},f.p2p.send=function(a,b,d){f._members.hasOwnProperty(a)?f._members[a].datachannel.send(c(b,d)):console.warn("Tried to send "+b+" "+JSON.stringify(d)+" to a unknow member id: "+a)},f.p2p.broadcast=function(a,b){f.members.forEach(function(d){f._members[d].datachannel.send(c(a,b))})}}var f={},g={iceServers:[{url:"stun:stun.l.google.com:19302"}]},h=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection;return f.isCompatible=function(){if(navigator.mozGetUserMedia)return console.warn("Firefox is not supported for now..."),!1;if(navigator.webkitGetUserMedia){var a=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10);return 31>a?(console.warn("Only Chrome >= M31 is supported (due to the use of SCTP-based datachannels)"),!1):!0}return console.warn("Your browser is not supported..."),!1},f.connect=function(a,b){var c=void 0!==b?b:g;return new e(a,c)},Object.defineProperty(e.prototype,"members",{get:function(){var a=this,b=[];for(var c in a._members)a._members.hasOwnProperty(c)&&null!==a._members[c].datachannel&&b.push(c);return b}}),e.prototype.on=function(a,b){this._eventCbs[a]=b},e.prototype._initiateWebRtcHandshake=function(a){var b=this,c=new h(b.webrtcConfig,{optional:[{DtlsSrtpKeyAgreement:!0}]});c.onicecandidate=function(c){c.candidate&&b._ws.send(d(a,"iceCandidate",{from:b.id,candidate:c.candidate}))},c.onnegotiationneeded=function(){c.createOffer(function(e){c.setLocalDescription(e,function(){b._ws.send(d(a,"sdpOffer",{from:b.id,sdp:e}))})})},b._members[a]={peerconn:c,datachannel:null};var e=c.createDataChannel("playrtc",{reliable:!0});e.onopen=function(){b._members[a].datachannel=e,b._isReady()&&b._triggerReady()},e.onmessage=function(c){b._handleP2PMsg(c,a)}},e.prototype._answerWebRtcHandshake=function(a,b){var c=this,e=new h(c.webrtcConfig,{optional:[{DtlsSrtpKeyAgreement:!0}]});c._members[a]={peerconn:e,datachannel:null},e.onicecandidate=function(b){b.candidate&&c._ws.send(d(a,"iceCandidate",{from:c.id,candidate:b.candidate}))},e.setRemoteDescription(new RTCSessionDescription(b),function(){e.createAnswer(function(b){e.setLocalDescription(b,function(){c._ws.send(d(a,"sdpAnswer",{from:c.id,sdp:b}))})})}),e.ondatachannel=function(b){var d=b.channel;d.onopen=function(){c._members[a].datachannel=d,c._eventCbs.hasOwnProperty(c._connectEvtName)&&c._eventCbs[c._connectEvtName].call(null,a)},d.onmessage=function(b){c._handleP2PMsg(b,a)}}},e.prototype._handleP2PMsg=function(a,b){var c=this,d=JSON.parse(a.data);c.p2p._msgCbs.hasOwnProperty(d.kind)?c.p2p._msgCbs[d.kind].call(null,b,d.data):console.error("Received unknow P2P msg kind: "+d.kind)},e.prototype._triggerReady=function(){var b=this;b.ready||(b.ready=!0,b._ws.send(a("ready",null)),b._eventCbs.hasOwnProperty(b._readyEvtName)&&b._eventCbs[b._readyEvtName].call(null))},e.prototype._isReady=function(){var a=this,b=!0;return a._initialMembers.forEach(function(c){a._members.hasOwnProperty(c)&&null===a._members[c].datachannel&&(b=!1)}),b},f});