/*! playrtc 2013-10-13 */
!function(a){"object"==typeof exports?module.exports=a():window.Playrtc=a()}(function(){"use strict";function a(a,b){return JSON.stringify({adminEvent:a,data:b})}function b(a,b){return JSON.stringify({event:a,data:b})}function c(a,b){return JSON.stringify({event:a,data:b})}function d(a,b,c){return JSON.stringify({adminEvent:"fwd",data:{to:a,msg:{adminEvent:b,data:c}}})}function e(d,e){var g=this;g.server=f.mixin({}),g.p2p=f.mixin({}),g.id=null,g.webrtcConfig=e,g.ready=!1,g._members={},g._initialMembers=[],g._ws=new WebSocket(d),g._ws.onmessage=function(b){var c=JSON.parse(b.data);if(c.hasOwnProperty("event"))g.server.trigger(c.event,c.data);else{var d=c.adminEvent,e=c.data;if("initInfo"===d)g.id=e.id,g._initialMembers=e.members,0===e.members.length?g._triggerReady():e.members.forEach(function(a){g._members.hasOwnProperty(a)||g._initiateWebRtcHandshake(a)}),setInterval(function(){g._ws.send(a("hb",null))},e.hbInterval);else if("sdpOffer"===d)g._answerWebRtcHandshake(e.from,e.sdp);else if("sdpAnswer"===d)g._members[e.from].peerconn.setRemoteDescription(new RTCSessionDescription(e.sdp));else if("iceCandidate"===d)g._members.hasOwnProperty(e.from)?g._members[e.from].peerconn.addIceCandidate(new RTCIceCandidate(e.candidate)):console.error("ICE candidate sent before sdp-offer!");else if("disconnect"===d&&g._members.hasOwnProperty(e.id)){try{g._members[e.id].datachannel.close(),g._members[e.id].peerconn.close()}catch(f){}delete g._members[e.id],g.trigger("memberleft",e.id),g._isReady()&&g._triggerReady()}}},g.server.send=function(a,c){g._ws.send(b(a,c))},g.p2p.send=function(a,b,d){g._members.hasOwnProperty(a)?g._members[a].datachannel.send(c(b,d)):console.warn("Tried to send "+b+" "+JSON.stringify(d)+" to a unknow member id: "+a)},g.p2p.broadcast=function(a,b){g.members.forEach(function(d){g._members[d].datachannel.send(c(a,b))})}}var f=window.BackboneEvents||require("backbone-events-standalone"),g={},h={iceServers:[{url:"stun:stun.l.google.com:19302"}]},i=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection;return g.isCompatible=function(){if(navigator.mozGetUserMedia)return console.warn("Firefox is not supported for now..."),!1;if(navigator.webkitGetUserMedia){var a=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10);return 31>a?(console.warn("Only Chrome >= M31 is supported (due to the use of SCTP-based datachannels)"),!1):!0}return console.warn("Your browser is not supported..."),!1},g.connect=function(a,b){b=b||{};var c=void 0!==b.webrtcConfig?b.webrtcConfig:h;return new e(a,c)},f.mixin(e.prototype),Object.defineProperty(e.prototype,"members",{get:function(){var a=this,b=[];for(var c in a._members)a._members.hasOwnProperty(c)&&null!==a._members[c].datachannel&&b.push(c);return b}}),e.prototype._initiateWebRtcHandshake=function(a){var b=this,c=new i(b.webrtcConfig,{optional:[{DtlsSrtpKeyAgreement:!0}]});c.onicecandidate=function(c){c.candidate&&b._ws.send(d(a,"iceCandidate",{from:b.id,candidate:c.candidate}))},c.onnegotiationneeded=function(){c.createOffer(function(e){c.setLocalDescription(e,function(){b._ws.send(d(a,"sdpOffer",{from:b.id,sdp:e}))})})},b._members[a]={peerconn:c,datachannel:null};var e=c.createDataChannel("Playrtc",{reliable:!0});e.onopen=function(){b._members[a].datachannel=e,b._isReady()&&b._triggerReady()},e.onmessage=function(c){b._handleP2PMsg(c,a)}},e.prototype._answerWebRtcHandshake=function(a,b){var c=this,e=new i(c.webrtcConfig,{optional:[{DtlsSrtpKeyAgreement:!0}]});c._members[a]={peerconn:e,datachannel:null},e.onicecandidate=function(b){b.candidate&&c._ws.send(d(a,"iceCandidate",{from:c.id,candidate:b.candidate}))},e.setRemoteDescription(new RTCSessionDescription(b),function(){e.createAnswer(function(b){e.setLocalDescription(b,function(){c._ws.send(d(a,"sdpAnswer",{from:c.id,sdp:b}))})})}),e.ondatachannel=function(b){var d=b.channel;d.onopen=function(){c._members[a].datachannel=d,c.trigger("newmember",a)},d.onmessage=function(b){c._handleP2PMsg(b,a)}}},e.prototype._handleP2PMsg=function(a,b){var c=this,d=JSON.parse(a.data);c.p2p.trigger(d.event,b,d.data)},e.prototype._triggerReady=function(){var b=this;b.ready||(b.ready=!0,b._ws.send(a("ready",null)),b.trigger("ready"))},e.prototype._isReady=function(){var a=this,b=!0;return a._initialMembers.forEach(function(c){a._members.hasOwnProperty(c)&&null===a._members[c].datachannel&&(b=!1)}),b},g});