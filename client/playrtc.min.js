/*! playrtc 2013-10-11 */
!function(a){function b(a,b){return JSON.stringify({adminKind:a,data:b})}function c(a,b){return JSON.stringify({kind:a,data:b})}function d(a,b,c){return JSON.stringify({from:a,kind:b,data:c})}function e(a,b,c){return JSON.stringify({adminKind:"fwd",data:{to:a,msg:{adminKind:b,data:c}}})}function f(a,e){var f=this;f.server={},f.p2p={},f.id,f.webrtcConfig=e,f.ready=!1,f._members={},f._initialMembers=[],f._ws=new WebSocket(a),f._eventCbs={},f._readyEvtName="ready",f._connectEvtName="newMember",f._disconnectEvtName="memberLeft",f.server._msgCbs={},f.p2p._msgCbs={},f._ws.onmessage=function(a){var c=JSON.parse(a.data);if(c.hasOwnProperty("kind"))f.server._msgCbs.hasOwnProperty(c.kind)?f.server._msgCbs[c.kind].call(null,c.data):console.error("Received unknow kind: "+c.kind);else{var d=c.adminKind,e=c.data;if("initInfo"===d)f.id=e.id,f._initialMembers=e.members,0===e.members.length?f._ready():e.members.forEach(function(a){f._members.hasOwnProperty(a)||f._initiateWebRtcHandshake(a)}),setInterval(function(){f._ws.send(b("hb",null))},e.hbInterval);else if("sdpOffer"===d)f._answerWebRtcHandshake(e.from,e.sdp);else if("sdpAnswer"===d)f._members[e.from].peerconn.setRemoteDescription(new RTCSessionDescription(e.sdp));else if("iceCandidate"===d)f._members.hasOwnProperty(e.from)?f._members[e.from].peerconn.addIceCandidate(new RTCIceCandidate(e.candidate)):console.error("ICE candidate sent before sdp-offer!");else if("disconnect"===d&&f._members.hasOwnProperty(e.id)){try{f._members[e.id].datachannel.close(),f._members[e.id].peerconn.close()}catch(g){}delete f._members[e.id],f._eventCbs.hasOwnProperty(f._disconnectEvtName)&&f._eventCbs[f._disconnectEvtName].call(null,e.id),f._isReady()&&f._ready()}}},f.server.onMsg=function(a,b){f.server._msgCbs[a]=b},f.server.send=function(a,b){f._ws.send(c(a,b))},f.p2p.onMsg=function(a,b){f.p2p._msgCbs[a]=b},f.p2p.send=function(a,b,c){f._members.hasOwnProperty(a)?f._members[a].datachannel.send(d(f.id,b,c)):console.warn("Tried to send "+b+" "+JSON.stringify(c)+" to a unknow member id: "+a)},f.p2p.broadcast=function(a,b){f.members.forEach(function(c){f._members[c].datachannel.send(d(f.id,a,b))})}}var g={},h={iceServers:[{url:"stun:stun.l.google.com:19302"}]},i=a.RTCPeerConnection||a.webkitRTCPeerConnection||a.mozRTCPeerConnection;g.isCompatible=function(){return navigator.mozGetUserMedia?(console.warn("Firefox is not supported for now..."),!1):navigator.webkitGetUserMedia?(webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]),31>webrtcDetectedVersion?(console.warn("Only Chrome >= M31 is supported (due to the use of SCTP-based datachannels)"),!1):!0):(console.warn("Your browser not supported..."),!1)},g.connect=function(a,b){var c=void 0!==b?b:h;return new f(a,c)},Object.defineProperty(f.prototype,"members",{get:function j(){var a=this,j=[];for(var b in a._members)a._members.hasOwnProperty(b)&&null!==a._members[b].datachannel&&j.push(b);return j}}),f.prototype.on=function(a,b){this._eventCbs[a]=b},f.prototype._initiateWebRtcHandshake=function(a){var b=this,c=new i(b.webrtcConfig,{optional:[{DtlsSrtpKeyAgreement:!0}]});c.onicecandidate=function(c){c.candidate&&b._ws.send(e(a,"iceCandidate",{from:b.id,candidate:c.candidate}))},c.onnegotiationneeded=function(){c.createOffer(function(d){c.setLocalDescription(d,function(){b._ws.send(e(a,"sdpOffer",{from:b.id,sdp:d}))})})},b._members[a]={peerconn:c,datachannel:null};var d=c.createDataChannel("playrtc",{reliable:!0});d.onopen=function(){b._members[a].datachannel=d,b._isReady()&&b._ready()},d.onmessage=function(a){b._handleP2PMsg(a)}},f.prototype._answerWebRtcHandshake=function(a,b){var c=this,d=new i(c.webrtcConfig,{optional:[{DtlsSrtpKeyAgreement:!0}]});c._members[a]={peerconn:d,datachannel:null},d.onicecandidate=function(b){b.candidate&&c._ws.send(e(a,"iceCandidate",{from:c.id,candidate:b.candidate}))},d.setRemoteDescription(new RTCSessionDescription(b),function(){d.createAnswer(function(b){d.setLocalDescription(b,function(){c._ws.send(e(a,"sdpAnswer",{from:c.id,sdp:b}))})})}),d.ondatachannel=function(b){var d=b.channel;d.onopen=function(){c._members[a].datachannel=d,c._eventCbs.hasOwnProperty(c._connectEvtName)&&c._eventCbs[c._connectEvtName].call(null,a)},d.onmessage=function(a){c._handleP2PMsg(a)}}},f.prototype._handleP2PMsg=function(a){var b=this,c=JSON.parse(a.data);b.p2p._msgCbs.hasOwnProperty(c.kind)?b.p2p._msgCbs[c.kind].call(null,c.from,c.data):console.error("Received unknow P2P msg kind: "+c.kind)},f.prototype._ready=function(){var a=this;a.ready||(a.ready=!0,a._ws.send(b("ready",null)),a._eventCbs.hasOwnProperty(a._readyEvtName)&&a._eventCbs[a._readyEvtName].call(null))},f.prototype._isReady=function(){var a=this,b=!0;return a._initialMembers.forEach(function(c){a._members.hasOwnProperty(c)&&null===a._members[c].datachannel&&(b=!1)}),b},a.Playrtc=g}(window);